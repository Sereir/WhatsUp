/**
 * Tests du middleware de validation
 */

const validationMiddleware = require('../../src/middleware/validation.middleware');
const { createMockRequest, createMockResponse, createMockNext } = require('../helpers/testHelpers');

describe('Validation Middleware Tests', () => {
  describe('Register validation', () => {
    it('devrait valider des donnÃ©es d\'inscription correctes', () => {
      const req = createMockRequest({
        body: {
          firstName: 'John',
          lastName: 'Doe',
          email: 'john@example.com',
          password: 'Password123!'
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      const middleware = validationMiddleware.validate(validationMiddleware.schemas.register);
      middleware(req, res, next);

      expect(next).toHaveBeenCalled();
      expect(res.status).not.toHaveBeenCalled();
    });

    it('devrait rejeter un email invalide', () => {
      const req = createMockRequest({
        body: {
          firstName: 'John',
          lastName: 'Doe',
          email: 'invalid-email',
          password: 'Password123!'
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      const middleware = validationMiddleware.validate(validationMiddleware.schemas.register);
      middleware(req, res, next);

      expect(res.status).toHaveBeenCalledWith(400);
      expect(res.json).toHaveBeenCalled();
      expect(next).not.toHaveBeenCalled();
    });

    it('devrait rejeter un mot de passe trop court', () => {
      const req = createMockRequest({
        body: {
          firstName: 'John',
          lastName: 'Doe',
          email: 'john@example.com',
          password: '12345'
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      const middleware = validationMiddleware.validate(validationMiddleware.schemas.register);
      middleware(req, res, next);

      expect(res.status).toHaveBeenCalledWith(400);
    });

    it('devrait rejeter des champs manquants', () => {
      const req = createMockRequest({
        body: {
          firstName: 'John',
          email: 'john@example.com'
          // lastName et password manquants
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      const middleware = validationMiddleware.validate(validationMiddleware.schemas.register);
      middleware(req, res, next);

      expect(res.status).toHaveBeenCalledWith(400);
      const response = res.json.mock.calls[0][0];
      expect(response.errors).toBeDefined();
      expect(response.errors.length).toBeGreaterThan(0);
    });
  });

  describe('Login validation', () => {
    it('devrait valider des identifiants de connexion corrects', () => {
      const req = createMockRequest({
        body: {
          email: 'john@example.com',
          password: 'Password123!'
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      const middleware = validationMiddleware.validate(validationMiddleware.schemas.login);
      middleware(req, res, next);

      expect(next).toHaveBeenCalled();
    });

    it('devrait rejeter une connexion sans email', () => {
      const req = createMockRequest({
        body: {
          password: 'Password123!'
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      const middleware = validationMiddleware.validate(validationMiddleware.schemas.login);
      middleware(req, res, next);

      expect(res.status).toHaveBeenCalledWith(400);
    });

    it('devrait rejeter une connexion sans mot de passe', () => {
      const req = createMockRequest({
        body: {
          email: 'john@example.com'
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      const middleware = validationMiddleware.validate(validationMiddleware.schemas.login);
      middleware(req, res, next);

      expect(res.status).toHaveBeenCalledWith(400);
    });
  });

  describe('Message validation', () => {
    it('devrait valider un message texte', () => {
      const req = createMockRequest({
        body: {
          conversationId: '507f1f77bcf86cd799439011',
          content: 'Hello World',
          type: 'text'
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      const middleware = validationMiddleware.validate(validationMiddleware.schemas.sendMessage);
      middleware(req, res, next);

      expect(next).toHaveBeenCalled();
    });

    it('devrait rejeter un message sans content', () => {
      const req = createMockRequest({
        body: {
          conversationId: '507f1f77bcf86cd799439011',
          type: 'text'
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      const middleware = validationMiddleware.validate(validationMiddleware.schemas.sendMessage);
      middleware(req, res, next);

      expect(res.status).toHaveBeenCalledWith(400);
    });

    it('devrait rejeter un type de message invalide', () => {
      const req = createMockRequest({
        body: {
          conversationId: '507f1f77bcf86cd799439011',
          content: 'Hello',
          type: 'invalid-type'
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      const middleware = validationMiddleware.validate(validationMiddleware.schemas.sendMessage);
      middleware(req, res, next);

      expect(res.status).toHaveBeenCalledWith(400);
    });
  });

  describe('AddReaction validation', () => {
    it('devrait valider une rÃ©action valide', () => {
      const req = createMockRequest({
        body: {
          emoji: 'ðŸ‘'
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      const middleware = validationMiddleware.validate(validationMiddleware.schemas.addReaction);
      middleware(req, res, next);

      expect(next).toHaveBeenCalled();
    });

    it('devrait rejeter une rÃ©action sans emoji', () => {
      const req = createMockRequest({
        body: {}
      });
      const res = createMockResponse();
      const next = createMockNext();

      const middleware = validationMiddleware.validate(validationMiddleware.schemas.addReaction);
      middleware(req, res, next);

      expect(res.status).toHaveBeenCalledWith(400);
    });
  });

  describe('UpdateProfile validation', () => {
    it('devrait valider une mise Ã  jour de profil', () => {
      const req = createMockRequest({
        body: {
          firstName: 'Jane',
          bio: 'Hello World'
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      const middleware = validationMiddleware.validate(validationMiddleware.schemas.updateProfile);
      middleware(req, res, next);

      expect(next).toHaveBeenCalled();
    });

    it('devrait rejeter un username invalide', () => {
      const req = createMockRequest({
        body: {
          username: 'ab' // Trop court
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      const middleware = validationMiddleware.validate(validationMiddleware.schemas.updateProfile);
      middleware(req, res, next);

      expect(res.status).toHaveBeenCalledWith(400);
    });
  });
});
