/**
 * Tests unitaires des middleware
 */

const jwt = require('jsonwebtoken');
const authMiddleware = require('../../src/middleware/auth.middleware');
const User = require('../../src/models/User');
const { connectDatabase, clearDatabase, closeDatabase } = require('../helpers/dbSetup');
const { createTestUser, createMockRequest, createMockResponse, createMockNext } = require('../helpers/testHelpers');

describe('Auth Middleware Tests', () => {
  beforeAll(async () => {
    await connectDatabase();
  });

  afterAll(async () => {
    await closeDatabase();
  });

  beforeEach(async () => {
    await clearDatabase();
  });

  describe('protect middleware', () => {
    it('devrait authentifier un utilisateur avec un token valide', async () => {
      const user = await createTestUser();
      const token = jwt.sign({ userId: user._id }, process.env.JWT_SECRET, { expiresIn: '1h' });

      const req = createMockRequest({
        headers: {
          authorization: `Bearer ${token}`
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      await authMiddleware(req, res, next);

      expect(next).toHaveBeenCalled();
      expect(req.user).toBeDefined();
      expect(req.user._id.toString()).toBe(user._id.toString());
    });

    it('ne devrait pas authentifier sans token', async () => {
      const req = createMockRequest({
        headers: {}
      });
      const res = createMockResponse();
      const next = createMockNext();

      await authMiddleware(req, res, next);

      expect(res.status).toHaveBeenCalledWith(401);
      expect(res.json).toHaveBeenCalledWith({
        success: false,
        message: expect.stringContaining('Token')
      });
    });

    it('ne devrait pas authentifier avec un token invalide', async () => {
      const req = createMockRequest({
        headers: {
          authorization: 'Bearer invalid-token'
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      await authMiddleware(req, res, next);

      expect(res.status).toHaveBeenCalledWith(401);
    });

    it('ne devrait pas authentifier avec un token expirÃ©', async () => {
      const user = await createTestUser();
      const token = jwt.sign({ userId: user._id }, process.env.JWT_SECRET, { expiresIn: '0s' });

      // Attendre que le token expire
      await new Promise(resolve => setTimeout(resolve, 100));

      const req = createMockRequest({
        headers: {
          authorization: `Bearer ${token}`
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      await authMiddleware(req, res, next);

      expect(res.status).toHaveBeenCalledWith(401);
    });

    it('ne devrait pas authentifier si l\'utilisateur n\'existe plus', async () => {
      const user = await createTestUser();
      const token = jwt.sign({ userId: user._id }, process.env.JWT_SECRET, { expiresIn: '1h' });

      // Supprimer l'utilisateur
      await User.findByIdAndDelete(user._id);

      const req = createMockRequest({
        headers: {
          authorization: `Bearer ${token}`
        }
      });
      const res = createMockResponse();
      const next = createMockNext();

      await authMiddleware(req, res, next);

      expect(res.status).toHaveBeenCalledWith(401);
    });
  });
});
